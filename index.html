<script>
(() => {
  const KEY = 'doggo_pet_love';
  const DEFAULT = {
    name: "LOVE üê∂",
    hunger: 50,
    happy: 60,
    energy: 70,
    createdAt: Date.now(),
    logs: []
  };

  // DOM
  const petImg = document.getElementById('petImg');
  const hungerBar = document.getElementById('hungerBar');
  const happyBar = document.getElementById('happyBar');
  const energyBar = document.getElementById('energyBar');
  const hungerVal = document.getElementById('hungerVal');
  const happyVal = document.getElementById('happyVal');
  const energyVal = document.getElementById('energyVal');
  const statusLine = document.getElementById('statusLine');
  const ageBadge = document.getElementById('ageBadge');
  const logBox = document.getElementById('logBox');
  const petNameInput = document.getElementById('petName');
  const themeColor = document.getElementById('themeColor');
  const petTitle = document.getElementById('petTitle');

  let pet = JSON.parse(localStorage.getItem(KEY) || 'null') || DEFAULT;

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏•‡∏≠‡∏î
  const dogImage = "images/Dog.png";

  function updateDogImage() {
    petImg.src = dogImage;
    petImg.onerror = () => {
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'>
          <rect width='100%' height='100%' fill='#fff3ee'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            font-size='24' fill='#ff8a5b'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏≤ üíî</text>
        </svg>
      `);
      petImg.src = `data:image/svg+xml;charset=utf-8,${svg}`;
    };
  }

  function applyState() {
    petNameInput.value = pet.name;
    updateDogImage();
    hungerVal.textContent = Math.round(pet.hunger);
    happyVal.textContent = Math.round(pet.happy);
    energyVal.textContent = Math.round(pet.energy);
    hungerBar.style.width = Math.min(100, Math.max(0, pet.hunger)) + '%';
    happyBar.style.width = Math.min(100, Math.max(0, pet.happy)) + '%';
    energyBar.style.width = Math.min(100, Math.max(0, pet.energy)) + '%';
    ageBadge.textContent = '‡∏≠‡∏≤‡∏¢‡∏∏: ' + Math.floor((Date.now() - pet.createdAt) / (1000*60*60*24)) + ' ‡∏ß‡∏±‡∏ô';
    const mood = pet.happy > 75 ? '‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : (pet.happy > 45 ? '‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ' : '‡∏´‡∏á‡∏≠‡∏¢');
    const health = (pet.hunger < 75 && pet.energy > 25) ? '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ' : '‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•';
    statusLine.textContent = `${health} ‚Ä¢ ${mood}`;
    petTitle.textContent = pet.name || DEFAULT.name;
  }

  // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏•‡πà‡∏ô / ‡∏û‡∏±‡∏Å / ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î ---
  function animateHappy() {
    petImg.classList.add("pet-happy");
    setTimeout(() => petImg.classList.remove("pet-happy"), 700);
  }
  function feed() {
    pet.hunger = Math.max(0, pet.hunger - 18);
    pet.happy = Math.min(100, pet.happy + 6);
    pet.energy = Math.min(100, pet.energy + 6);
    animateHappy();
    saveState("‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£: üçñ ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¥‡∏ß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç");
    applyState();
  }
  function play() {
    if (pet.energy < 12) {
      addLog("‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô üò¥");
      return;
    }
    pet.happy = Math.min(100, pet.happy + 16);
    pet.hunger = Math.min(100, pet.hunger + 12);
    pet.energy = Math.max(0, pet.energy - 18);
    animateHappy();
    saveState("‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô: üéæ ‡∏™‡∏ô‡∏∏‡∏Å‡∏°‡∏≤‡∏Å!");
    applyState();
  }
  function sleep() {
    pet.energy = Math.min(100, pet.energy + 32);
    pet.hunger = Math.min(100, pet.hunger + 6);
    saveState("‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô: üò¥ ‡∏ü‡∏∑‡πâ‡∏ô‡∏û‡∏•‡∏±‡∏á");
    applyState();
  }
  function groom() {
    pet.happy = Math.min(100, pet.happy + 8);
    saveState("‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î: üõÅ ‡∏´‡∏≠‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î");
    applyState();
  }

  // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞ Log ---
  function saveState(text) {
    pet.updatedAt = Date.now();
    if (text) addLog(text);
    localStorage.setItem(KEY, JSON.stringify(pet));
  }
  function addLog(text) {
    const time = new Date().toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"});
    pet.logs.unshift({ time, text });
    if (pet.logs.length > 200) pet.logs.pop();
    renderLogs();
  }
  function renderLogs() {
    logBox.innerHTML = "";
    if (!pet.logs.length) {
      logBox.innerHTML = "<p class='small'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üêæ</p>";
      return;
    }
    pet.logs.forEach((l) => {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${l.time}</strong> ‚Äî ${l.text}`;
      logBox.appendChild(p);
    });
  }

  // --- ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° ---
  document.getElementById("feedBtn").addEventListener("click", feed);
  document.getElementById("playBtn").addEventListener("click", play);
  document.getElementById("sleepBtn").addEventListener("click", sleep);
  document.getElementById("groomBtn").addEventListener("click", groom);

  // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
  applyState();
  renderLogs();
})();
</script>
